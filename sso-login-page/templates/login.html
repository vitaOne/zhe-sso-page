<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Sign in</title>
    <meta name="description" content="统一认证授权中心"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <link rel="stylesheet" th:href="@{/assets/bootstrap/css/bootstrap.min.css}"
          href="../static/assets/bootstrap/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" th:href="@{/css/login.css}" href="../static/css/login.css"/>
</head>
<body>
<div class="error-message">
    <span class="error-style" id="error-msg">
      This account has been locked, please wait <span id="countdown">15</span> minutes.
    </span>
</div>
<div class="login-wrapper">
    <div class="logo-wrapper">
        <img src="./images/logo.png" width="333px" height="30px" alt="logo"/>
        <p class="company-desc">
            All-in-One solution. Build your successful business with one single
            platform.
        </p>
    </div>
    <div class="login-content">
        <div class="form-center">
            <div class="login-logo">
                <h1>Sign in to ThingsMatrix</h1>
            </div>
            <div class="login-form">
                <form id="form-user" onsubmit="return false" action="" method="post">
                    <div class="from-content">
                        <img id="email" class="input-prefix" src="./images/Email.png" width="14px" height="11px"
                             alt="email"/>
                        <img id="email-active" style="display: none" class="input-prefix"
                             src="./images/Email_active.png"
                             width="14px" height="11px" alt="email"/>
                        <input type="text" class="form-input" name="username" placeholder="Email" id="username"
                               onfocus="usernameFocus()" onblur="usernameHandleBlur()"/>
                        <p id="usernameMsg" style="
                  display: none;
                  color: #FF4D4F;
                  font-size: 12px;
                  text-align: left;
                  margin-top: 0.5rem;
                  margin-bottom: 0;
                ">
                            Email is required
                        </p>
                    </div>
                    <div style="position: relative" class="form-pass">
                        <img id="passwordImg" class="input-prefix" src="./images/Password.png" width="12px"
                             height="12px"
                             alt="email"/>
                        <img id="password-active" style="display: none" class="input-prefix"
                             src="./images/Password_active.png"
                             width="12px" height="12px" alt="email"/>
                        <input type="password" class="form-input" id="textPassword" placeholder="Password"
                               oncopy="return false"
                               oncut="return false" onfocus="passwordFocus()" onblur="passwordHandleBlur()"/>
                        <input type="hidden" class="form-input" name="password" id="password"/>
                        <img id="hide" class="input-suffix btn-pointer" style="display: none"
                             src="./images/show_active.png"
                             width="13px" height="10px" alt="hide" onclick="hidePassword()"/>
                        <img id="show" class="input-suffix btn-pointer" src="./images/hide_active.png" width="13px"
                             height="10px"
                             alt="hide" onclick="showPassword()"/>
                        <p id="passwordMsg" style="
                  display: none;
                  color: #FF4D4F;
                  font-size: 12px;
                  text-align: left;
                  margin-top: 0.5rem;
                  margin-bottom: 0;
                ">
                            Password is required
                        </p>
                        <p id="errMsg" style="
                  color: #FF4D4F;
                  font-size: 12px;
                  text-align: left;
                  margin-top: 0.5rem;
                  margin-bottom: 0;
                  display: none;
                ">
                            Incorrect email or password, please enter again
                        </p>
                    </div>
                    <div class="password-content">
                        <a style="cursor: pointer;" th:href="${forgetPasswordLink}">Forgot your password?</a>
                    </div>
                    <button class="btn-submit" onclick="severCheck(this)">Sign In</button>
                    <input type="hidden" name="redirectUri" id="redirectUriLogin"/>
                </form>
                <div class="register-content">
                    <p>
                        <span>Don't have an account?</span>
                        <a style="cursor: pointer;" onclick="signUp()">Sign Up</a>
                    </p>
                    <input type="hidden" id="registerLink" th:value="${registerLink}"/>
                    <input type="hidden" id="redirectUri" th:value="${redirect_uri}"/>
                </div>
            </div>
        </div>
    </div>
    <div class="Copyright">Copyright © 2021 ThingsMatrix Inc. All Rights Reserved.</div>
</div>
</body>
<script th:src="@{/assets/js/jquery-2.2.4.min.js}" src="../static/assets/js/jquery-2.2.4.min.js"></script>
<script type="text/javascript" th:src="@{/assets/js/md5.min.js}" src="../static/assets/js/md5.min.js"></script>
<script type="text/javascript">
    function openErrorToast(content) {
        $('#countdown').text(content)
        $("#error-msg").show();
        setTimeout(() => {
            $("#error-msg").hide();
        }, 3 * 1000);
    }

    function signUp() {
        const registerLink = $("#registerLink").val();
        let redirectUri = getQueryString("redirectUri");
        if (redirectUri == null) {
            redirectUri = $("#redirectUri").val();
        }
        window.location.href = registerLink + "?redirectUri=" + redirectUri;
    }

    function getQueryString(name) {
        const reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        const r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    function severCheck(e) {
        if (usernameHandleBlur() && passwordHandleBlur()) {
            $(e).attr("disabled", "disabled");
            const tmp = md5($("#textPassword").val());
            $("#password").val(tmp);
            let redirectUri = getQueryString("redirectUri");
            $("#redirectUriLogin").val(redirectUri);
            const form = document.getElementById("form-user");
            form.submit();
        }
    }

    function usernameHandleBlur() {
        $("#email").show();
        $("#email-active").hide();
        const emailRule =
            /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        if ($("#username").val() == "") {
            $("#usernameMsg").text("Email is required");
            $("#usernameMsg").show();
            $("#username").addClass("error");
            return false;
        } else if (!emailRule.test($("#username").val())) {
            $("#usernameMsg").text("Please input the correct email");
            $("#usernameMsg").show();
            $("#username").addClass("error");
            return false;
        } else {
            $("#usernameMsg").hide();
            $("#email").show();
            $("#email-active").hide();
            $("#username").val(jQuery.trim($("#username").val()));
        }
        $("#username").removeClass("error");
        return true;
    }

    function usernameFocus() {
        $("#email").hide();
        $("#email-active").show();
    }

    function passwordHandleBlur() {
        $("#passwordImg").show();
        $("#password-active").hide();
        const pwdRule = /^.{6,18}$/;
        if ($("#textPassword").val() == "") {
            $("#passwordMsg").text("Password is required");
            $("#passwordMsg").show();
            $("#textPassword").addClass("error");
            return false;
        } else if (!pwdRule.test($("#textPassword").val())) {
            $("#passwordMsg").text("Please input the correct password");
            $("#passwordMsg").show();
            $("#textPassword").addClass("error");
            return false;
        } else {
            $("#textPassword").removeClass("error");
            $("#passwordMsg").hide();
        }
        return true;
    }

    let first = true;

    function passwordFocus() {
        $("#passwordImg").hide();
        $("#password-active").show();
        if (!first) {
            $("#errMsg").hide();
        }
        first = false;
    }

    function hidePassword() {
        $("#textPassword").attr("type", "password");
        $("#hide").hide();
        $("#show").show();
    }

    function showPassword() {
        $("#textPassword").attr("type", "text");
        $("#hide").show();
        $("#show").hide();
    }
</script>
<script th:inline="javascript" type="text/javascript">
    (function () {
        const username = [[${username}]];
        const lock_time = [[${lock_time}]];
        if (lock_time) {
            openErrorToast(lock_time);
            $("#username").val(username);
        } else if (username) {
            $("#username").val(username);
            $("#errMsg").show();
        }
    })();
</script>
</html>
